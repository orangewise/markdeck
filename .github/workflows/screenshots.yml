name: Generate Grid View Screenshots

on:
  workflow_dispatch: # Allow manual trigger
  push:
    paths:
      - 'markdeck/static/**'
      - 'examples/**'

jobs:
  screenshots:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Install Playwright and browsers
      - name: Install Playwright with browsers
        run: |
          npm install -g playwright
          npx playwright install --with-deps chromium

      # Install MarkDeck
      - name: Install MarkDeck dependencies
        run: |
          pip install -e .

      # Start server in background
      - name: Start MarkDeck server
        run: |
          markdeck present examples/features.md --port 8888 --no-browser &
          sleep 5
          curl -f http://127.0.0.1:8888/ || exit 1

      # Install Python dependencies for screenshot script
      - name: Install screenshot dependencies
        run: |
          pip install playwright pillow

      # Run screenshot capture
      - name: Capture screenshots
        run: |
          python capture_screenshots.py

      # Upload screenshots as artifacts
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: grid-view-screenshots
          path: screenshots/
          retention-days: 90

      # Optionally commit screenshots back to repo
      - name: Commit screenshots
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add screenshots/
          git diff --staged --quiet || git commit -m "Update grid view screenshots [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
